{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///home/bangcs/Documents/tryout_tka/app/api/payment/create-invoice/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport crypto from 'crypto';\n\nconst supabase = createClient(\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\n);\n\nexport async function POST(request: NextRequest) {\n  try {\n    const { userId, email, customerName, tryoutId } = await request.json();\n\n    // Validasi input\n    if (!tryoutId || !userId || !email) {\n      return NextResponse.json(\n        { error: 'Missing required fields' },\n        { status: 400 }\n      );\n    }\n\n    const merchantCode = process.env.DUITKU_MERCHANT_CODE;\n    const apiKey = process.env.DUITKU_API_KEY;\n    const baseUrl = process.env.DUITKU_BASE_URL;\n    \n    // Get app URL from env or use request origin as fallback\n    const appUrl = process.env.NEXT_PUBLIC_APP_URL || \n      `${request.headers.get('x-forwarded-proto') || 'http'}://${request.headers.get('host') || 'localhost:3000'}`;\n\n    if (!merchantCode || !apiKey || !baseUrl) {\n      console.error('Missing required environment variables:', {\n        hasMerchantCode: !!merchantCode,\n        hasApiKey: !!apiKey,\n        hasBaseUrl: !!baseUrl,\n      });\n      return NextResponse.json(\n        { error: 'Payment gateway configuration error' },\n        { status: 500 }\n      );\n    }\n\n    // Generate unique order ID\n    const merchantOrderId = `PEMBAHASAN-${tryoutId}-${Date.now()}`;\n    const paymentAmount = 15000; // Rp 15.000\n    const productDetails = 'Unlock Pembahasan Premium - Tryout';\n    const paymentMethod = 'SP'; // Shopeepay, bisa diganti sesuai kebutuhan\n    const returnUrl = `${appUrl}/payment/callback`;\n    const callbackUrl = `${appUrl}/api/payment/callback`;\n    const expiryPeriod = 60; // 60 menit\n\n    // Generate signature\n    const signature = crypto\n      .createHash('md5')\n      .update(`${merchantCode}${merchantOrderId}${paymentAmount}${apiKey}`)\n      .digest('hex');\n\n    // Request body untuk Duitku\n    const requestBody = {\n      merchantCode,\n      paymentAmount,\n      paymentMethod,\n      merchantOrderId,\n      productDetails,\n      email,\n      customerVaName: customerName || email,\n      callbackUrl,\n      returnUrl,\n      signature,\n      expiryPeriod,\n    };\n\n    // Cek apakah user sudah unlock tryout ini sebelumnya\n    // Using count with specific column to avoid id column issue\n    const { count: successCount, error: successError } = await supabase\n      .from('unlocked_explanations')\n      .select('payment_status', { count: 'exact', head: true })\n      .eq('user_id', userId)\n      .eq('tryout_id', tryoutId)\n      .eq('payment_status', 'success');\n\n    if (successError && successError.code !== '42703') {\n      console.error('Error checking existing unlock:', successError);\n      return NextResponse.json(\n        { error: 'Failed to check unlock status' },\n        { status: 500 }\n      );\n    }\n\n    if (successCount && successCount > 0) {\n      return NextResponse.json(\n        { error: 'Pembahasan tryout ini sudah di-unlock sebelumnya' },\n        { status: 400 }\n      );\n    }\n\n    // Check for pending payments and return payment URL if exists\n    const { data: pendingPayment, error: pendingError } = await supabase\n      .from('unlocked_explanations')\n      .select('payment_url, merchant_order_id, payment_status')\n      .eq('user_id', userId)\n      .eq('tryout_id', tryoutId)\n      .eq('payment_status', 'pending')\n      .maybeSingle();\n\n    if (pendingError && pendingError.code !== '42703') {\n      console.error('Error checking pending unlock:', pendingError);\n      return NextResponse.json(\n        { error: 'Failed to check unlock status' },\n        { status: 500 }\n      );\n    }\n\n    if (pendingPayment && pendingPayment.payment_url) {\n      return NextResponse.json({\n        success: false,\n        error: 'Anda masih memiliki pembayaran yang sedang diproses',\n        pendingPayment: true,\n        paymentUrl: pendingPayment.payment_url,\n        merchantOrderId: pendingPayment.merchant_order_id,\n      });\n    }\n\n    // Simpan atau perbarui pending unlock record\n    const { data: unlockData, error: unlockError } = await supabase\n      .from('unlocked_explanations')\n      .upsert({\n        user_id: userId,\n        tryout_id: tryoutId,\n        merchant_order_id: merchantOrderId,\n        payment_amount: paymentAmount,\n        payment_status: 'pending',\n        payment_method: paymentMethod,\n        email,\n        payment_url: null,\n        payment_reference: null,\n        unlocked_at: null,\n      }, { onConflict: 'user_id,tryout_id' })\n      .select('merchant_order_id, user_id, tryout_id, payment_status')\n      .single();\n\n    if (unlockError) {\n      console.error('Error creating unlock record:', unlockError);\n      return NextResponse.json(\n        { error: 'Failed to create unlock record' },\n        { status: 500 }\n      );\n    }\n\n    const duitkuResponse = await fetch(`${baseUrl}/api/merchant/v2/inquiry`, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n      },\n      body: JSON.stringify(requestBody),\n    });\n\n    const responseText = await duitkuResponse.text();\n    console.log('Duitku Response:', responseText);\n\n    let duitkuData;\n    try {\n      duitkuData = JSON.parse(responseText);\n    } catch (e) {\n      console.error('Failed to parse Duitku response:', responseText);\n      return NextResponse.json(\n        { error: 'Invalid response from payment gateway' },\n        { status: 500 }\n      );\n    }\n\n    if (duitkuData.statusCode !== '00') {\n      return NextResponse.json(\n        { error: duitkuData.statusMessage || 'Failed to create payment' },\n        { status: 400 }\n      );\n    }\n\n    // Update unlock record dengan reference dari Duitku\n    await supabase\n      .from('unlocked_explanations')\n      .update({\n        payment_reference: duitkuData.reference,\n        payment_url: duitkuData.paymentUrl,\n      })\n      .eq('merchant_order_id', merchantOrderId);\n\n    return NextResponse.json({\n      success: true,\n      paymentUrl: duitkuData.paymentUrl,\n      reference: duitkuData.reference,\n      merchantOrderId,\n    });\n  } catch (error) {\n    console.error('Error creating payment:', error);\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    return NextResponse.json(\n      { error: 'Internal server error', details: errorMessage },\n      { status: 500 }\n    );\n  }\n}"],"names":[],"mappings":"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","debugId":null}}]
}